<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM æœºå¯†æŠ•ç¥¨ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // å¤‡ç”¨CDNæº
        let ethersLoadAttempts = 0;
        
        function loadEthers() {
            ethersLoadAttempts++;
            console.log(`ğŸ”„ å°è¯•åŠ è½½Ethers.js (ç¬¬${ethersLoadAttempts}æ¬¡)`);
            
            if (typeof ethers !== 'undefined') {
                console.log('âœ… Ethers.jså·²æˆåŠŸåŠ è½½:', ethers.version);
                window.ethersLoaded = true;
                return;
            }
            
            if (ethersLoadAttempts >= 3) {
                console.error('âŒ å¤šæ¬¡å°è¯•åEthers.jsä»æœªåŠ è½½');
                return;
            }
            
            // å°è¯•ä¸åŒçš„CDNæº
            const cdnSources = [
                'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdn.skypack.dev/ethers@5.7.2',
                'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
            ];
            
            const script = document.createElement('script');
            script.src = cdnSources[ethersLoadAttempts - 1] || cdnSources[0];
            script.onload = function() {
                console.log('âœ… Ethers.jsä»å¤‡ç”¨æºåŠ è½½æˆåŠŸ');
                window.ethersLoaded = true;
            };
            script.onerror = function() {
                console.warn(`âš ï¸ CDNæº ${script.src} åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...`);
                setTimeout(loadEthers, 1000);
            };
            document.head.appendChild(script);
        }
        
        // é¡µé¢åŠ è½½åæ£€æŸ¥Ethers.js
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof ethers === 'undefined') {
                    loadEthers();
                } else {
                    console.log('âœ… Ethers.js v5å·²åŠ è½½:', ethers.version);
                    window.ethersLoaded = true;
                }
            }, 500);
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header>
            <h1>ğŸ” FHEVM æœºå¯†æŠ•ç¥¨ç³»ç»Ÿ</h1>
            <p>åŸºäºå…¨åŒæ€åŠ å¯†çš„å®‰å…¨æŠ•ç¥¨å¹³å°</p>
        </header>

        <!-- è¿æ¥é’±åŒ…åŒºåŸŸ -->
        <div class="wallet-status" id="walletSection">
            <div class="wallet-info" id="walletInfo" style="display: none;">
                <span>å·²è¿æ¥: </span>
                <span id="walletAddress"></span>
                <button onclick="disconnectWallet()" class="btn btn-danger">æ–­å¼€è¿æ¥</button>
            </div>
            <button onclick="connectWallet()" class="btn btn-primary" id="connectBtn">
                ğŸ”— è¿æ¥é’±åŒ…
            </button>
        </div>

        <!-- åˆçº¦åœ°å€é…ç½® -->
        <div class="section">
            <h3>ğŸ“œ åˆçº¦é…ç½®</h3>
            <div class="form-group">
                <label>åˆçº¦åœ°å€:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="contractAddressInput" placeholder="è¾“å…¥åˆçº¦åœ°å€..." style="flex: 1;">
                    <button onclick="updateContractAddress()" class="btn btn-success">æ›´æ–°åœ°å€</button>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    å½“å‰åœ°å€: <span id="currentContractAddress"></span>
                </small>
            </div>
            
            <!-- éƒ¨ç½²æŒ‡å— -->
            <div class="card" style="margin-top: 15px; background: #f8f9fa;">
                <h4>ğŸš€ åˆçº¦éƒ¨ç½²æŒ‡å—</h4>
                <p style="margin-bottom: 10px;">å¦‚æœæ‚¨è¿˜æ²¡æœ‰éƒ¨ç½²åˆçº¦ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>ç¡®ä¿ <code>.env</code> æ–‡ä»¶ä¸­å·²è®¾ç½®æ‚¨çš„ç§é’¥</li>
                    <li>ä»Sepoliaæ°´é¾™å¤´è·å–æµ‹è¯•ETH: 
                        <a href="https://sepoliafaucet.com/" target="_blank">SepoliaFaucet</a> | 
                        <a href="https://faucets.chain.link/sepolia" target="_blank">Chainlink</a>
                    </li>
                    <li>åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ: <code>npm run deploy</code></li>
                    <li>å¤åˆ¶éƒ¨ç½²æˆåŠŸåæ˜¾ç¤ºçš„åˆçº¦åœ°å€</li>
                    <li>å°†åˆçº¦åœ°å€ç²˜è´´åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†ä¸­</li>
                </ol>
                <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <strong>ğŸ’¡ æç¤º:</strong> 
                    æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨å·²éƒ¨ç½²çš„æµ‹è¯•åˆçº¦åœ°å€æ¥ä½“éªŒåŠŸèƒ½ã€‚
                </div>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid">
            <!-- ç®¡ç†å‘˜åŠŸèƒ½ -->
            <div class="section" id="adminSection" style="display: none;">
                <h2>ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜åŠŸèƒ½</h2>
                
                <!-- æ³¨å†ŒæŠ•ç¥¨è€… -->
                <div class="card">
                    <h3>æ³¨å†ŒæŠ•ç¥¨è€…</h3>
                    <div class="form-group">
                        <input type="text" id="voterAddress" placeholder="æŠ•ç¥¨è€…åœ°å€ (0x...)">
                        <button onclick="registerVoter()" class="btn btn-success">æ³¨å†Œ</button>
                    </div>
                </div>

                <!-- æ‰¹é‡æ³¨å†Œ -->
                <div class="card">
                    <h3>æ‰¹é‡æ³¨å†ŒæŠ•ç¥¨è€…</h3>
                    <div class="form-group">
                        <textarea id="voterAddresses" placeholder="æŠ•ç¥¨è€…åœ°å€åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªåœ°å€" style="min-height: 100px; width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"></textarea>
                        <button onclick="registerVoters()" class="btn btn-success">æ‰¹é‡æ³¨å†Œ</button>
                    </div>
                </div>

                <!-- æ·»åŠ æŠ•ç¥¨é€‰é¡¹ -->
                <div class="card">
                    <h3>æ·»åŠ æŠ•ç¥¨é€‰é¡¹</h3>
                    <div class="form-group">
                        <input type="text" id="optionName" placeholder="é€‰é¡¹åç§°">
                        <button onclick="addVoteOption()" class="btn btn-success">æ·»åŠ </button>
                    </div>
                </div>

                <!-- å¼€å§‹æŠ•ç¥¨ -->
                <div class="card">
                    <h3>å¼€å§‹æŠ•ç¥¨</h3>
                    <div class="form-group">
                        <input type="number" id="votingDuration" placeholder="æŠ•ç¥¨æŒç»­æ—¶é—´(ç§’)" value="3600">
                        <button onclick="startVoting()" class="btn btn-success">å¼€å§‹æŠ•ç¥¨</button>
                    </div>
                    <div class="form-group">
                        <button onclick="quickStartVoting()" class="btn btn-primary">å¿«é€Ÿå¼€å§‹æŠ•ç¥¨ (1å°æ—¶)</button>
                        <small style="color: #666; display: block; margin-top: 5px;">å¿«é€Ÿå¼€å§‹1å°æ—¶çš„æŠ•ç¥¨æ´»åŠ¨</small>
                    </div>
                </div>

                <!-- ç»“æŸæŠ•ç¥¨ -->
                <div class="card">
                    <h3>ç»“æŸæŠ•ç¥¨</h3>
                    <button onclick="endVoting()" class="btn btn-danger">ç»“æŸæŠ•ç¥¨</button>
                </div>

                <!-- æˆæƒæŸ¥çœ‹è€… -->
                <div class="card">
                    <h3>æˆæƒæŸ¥çœ‹è€…</h3>
                    <div class="form-group">
                        <input type="text" id="viewerAddress" placeholder="æŸ¥çœ‹è€…åœ°å€ (0x...)">
                        <button onclick="authorizeViewer()" class="btn btn-success">æˆæƒ</button>
                    </div>
                    <div class="form-group">
                        <button onclick="authorizeSelf()" class="btn btn-primary">æˆæƒè‡ªå·±æŸ¥çœ‹ç»“æœ</button>
                        <small style="color: #666; display: block; margin-top: 5px;">å¿«é€Ÿæˆæƒå½“å‰è´¦æˆ·æŸ¥çœ‹æŠ•ç¥¨ç»“æœ</small>
                    </div>
                </div>
            </div>

            <!-- æŠ•ç¥¨è€…åŠŸèƒ½ -->
            <div class="section" id="voterSection" style="display: none;">
                <h2>ğŸ—³ï¸ æŠ•ç¥¨åŠŸèƒ½</h2>
                
                <!-- æŠ•ç¥¨é€‰é¡¹åˆ—è¡¨ -->
                <div class="card">
                    <h3>æŠ•ç¥¨é€‰é¡¹</h3>
                    <div id="voteOptions" class="option-list">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <!-- æŠ•ç¥¨æ“ä½œ -->
                <div class="card">
                    <h3>æŠ•ç¥¨</h3>
                    <div class="form-group">
                        <select id="voteSelect">
                            <option value="">é€‰æ‹©æŠ•ç¥¨é€‰é¡¹</option>
                        </select>
                        <button onclick="castVote()" class="btn btn-primary">æŠ•ç¥¨</button>
                    </div>
                </div>
            </div>

            <!-- æŸ¥çœ‹ç»“æœ -->
            <div class="section" id="resultsSection" style="display: none;">
                <h2>ğŸ“Š æŠ•ç¥¨ç»“æœ</h2>
                <div class="card">
                    <h3>åŠ å¯†æŠ•ç¥¨ç»“æœ</h3>
                    <div id="voteResults">
                        <p>ç»“æœå°†åœ¨æŠ•ç¥¨ç»“æŸåæ˜¾ç¤º</p>
                    </div>
                    <button onclick="getVoteResults()" class="btn btn-success">è·å–ç»“æœ</button>
                </div>
            </div>

            <!-- çŠ¶æ€ä¿¡æ¯ -->
            <div class="section">
                <h2>ğŸ“‹ ç³»ç»ŸçŠ¶æ€</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="card">
                        <label>æŠ•ç¥¨çŠ¶æ€:</label>
                        <span id="votingStatus" class="vote-count">æœªçŸ¥</span>
                    </div>
                    <div class="card">
                        <label>æŠ•ç¥¨è€…æ€»æ•°:</label>
                        <span id="totalVoters" class="vote-count">0</span>
                    </div>
                    <div class="card">
                        <label>é€‰é¡¹æ•°é‡:</label>
                        <span id="optionsCount" class="vote-count">0</span>
                    </div>
                    <div class="card">
                        <label>åˆçº¦åœ°å€:</label>
                        <span id="contractAddress" class="vote-count" style="font-size: 0.8rem; word-break: break-all;">æœªéƒ¨ç½²</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div id="logContainer" style="background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>
            <button onclick="clearLog()" class="btn btn-danger">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
            <div class="loading"></div>
            <p id="loadingText" style="margin-top: 15px;">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html> 