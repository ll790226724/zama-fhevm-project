<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM Confidential Voting System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Backup CDN sources
        let ethersLoadAttempts = 0;
        
        function loadEthers() {
            ethersLoadAttempts++;
            console.log(`üîÑ Attempting to load Ethers.js (attempt ${ethersLoadAttempts})`);
            
            if (typeof ethers !== 'undefined') {
                console.log('‚úÖ Ethers.js loaded successfully:', ethers.version);
                window.ethersLoaded = true;
                return;
            }
            
            const backupCDNs = [
                'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js'
            ];
            
            if (ethersLoadAttempts <= backupCDNs.length) {
                const script = document.createElement('script');
                script.src = backupCDNs[ethersLoadAttempts - 1];
                script.onload = () => {
                    console.log('‚úÖ Ethers.js backup CDN loaded successfully');
                    window.ethersLoaded = true;
                };
                script.onerror = () => {
                    console.log('‚ùå Backup CDN failed, trying next...');
                    loadEthers();
                };
                document.head.appendChild(script);
            } else {
                console.error('‚ùå All CDN sources failed');
                window.ethersLoaded = false;
            }
        }
        
        // Check and load if needed
        setTimeout(() => {
            if (typeof ethers === 'undefined') {
                loadEthers();
            } else {
                window.ethersLoaded = true;
            }
        }, 1000);
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üîê FHEVM Confidential Voting System</h1>
            <p>Secure and private voting powered by Fully Homomorphic Encryption</p>
        </header>

        <!-- Wallet Connection -->
        <div class="section">
            <div class="wallet-status" id="walletStatus">
                <h2>üîó Wallet Connection</h2>
                <div class="status-info">
                    <p><strong>Status:</strong> <span id="connectionStatus">Not Connected</span></p>
                    <p><strong>Account:</strong> <span id="walletAddress">-</span></p>
                    <p><strong>Balance:</strong> <span id="walletBalance">-</span></p>
                    <p><strong>Network:</strong> <span id="networkInfo">-</span></p>
                </div>
                <button onclick="connectWallet()" class="btn btn-primary" id="connectBtn">Connect Wallet</button>
                <button onclick="disconnectWallet()" class="btn btn-secondary" id="disconnectBtn" style="display: none;">Disconnect</button>
            </div>
        </div>

        <!-- Contract Information -->
        <div class="section">
            <h3>üìú Contract Information</h3>
            <div class="form-group">
                <label>Contract Address:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="contractAddressInput" placeholder="Enter contract address..." style="flex: 1;">
                    <button onclick="updateContractAddress()" class="btn btn-success">Update Address</button>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Current Address: <span id="currentContractAddress"></span>
                </small>
            </div>
            
            <!-- Deployment Guide -->
            <div class="card" style="margin-top: 15px; background: #f8f9fa;">
                <h4>üöÄ Contract Deployment Guide</h4>
                <p style="margin-bottom: 10px;">If you haven't deployed the contract yet, follow these steps:</p>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>Ensure your private key is set in the <code>.env</code> file</li>
                    <li>Get test ETH from Sepolia faucets: 
                        <a href="https://sepoliafaucet.com/" target="_blank">SepoliaFaucet</a> | 
                        <a href="https://faucets.chain.link/sepolia" target="_blank">Chainlink</a>
                    </li>
                    <li>Run in project root: <code>npm run deploy</code></li>
                    <li>Copy the deployed contract address</li>
                    <li>Paste the contract address in the input field above</li>
                </ol>
                <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                    <strong>üí° Tip:</strong> 
                    You can also use an already deployed test contract address to experience the functionality.
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="section">
            <h3>üìä System Status</h3>
            <div class="grid">
                <div class="status-badge">
                    <span class="label">Voting Status:</span>
                    <span id="votingStatus" class="value">-</span>
                </div>
                <div class="status-badge">
                    <span class="label">Total Voters:</span>
                    <span id="totalVoters" class="value">-</span>
                </div>
                <div class="status-badge">
                    <span class="label">Vote Options:</span>
                    <span id="totalOptions" class="value">-</span>
                </div>
            </div>
        </div>

        <!-- Main Functions -->
        <div class="grid">
            <!-- Admin Functions -->
            <div class="section" id="adminSection" style="display: none;">
                <h2>üë®‚Äçüíº Admin Functions</h2>
                
                <!-- Register Voter -->
                <div class="card">
                    <h3>Register Voter</h3>
                    <div class="form-group">
                        <input type="text" id="voterAddress" placeholder="Voter address (0x...)">
                        <button onclick="registerVoter()" class="btn btn-success">Register</button>
                    </div>
                </div>

                <!-- Batch Registration -->
                <div class="card">
                    <h3>Batch Register Voters</h3>
                    <div class="form-group">
                        <textarea id="voterAddresses" placeholder="Voter addresses list, one per line" style="min-height: 100px; width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"></textarea>
                        <button onclick="registerVoters()" class="btn btn-success">Batch Register</button>
                    </div>
                </div>

                <!-- Add Vote Option -->
                <div class="card">
                    <h3>Add Vote Option</h3>
                    <div class="form-group">
                        <input type="text" id="optionName" placeholder="Option name">
                        <button onclick="addVoteOption()" class="btn btn-success">Add Option</button>
                    </div>
                </div>

                <!-- Start Voting -->
                <div class="card">
                    <h3>Start Voting</h3>
                    <div class="form-group">
                        <input type="number" id="votingDuration" placeholder="Duration in seconds" value="3600">
                        <button onclick="startVoting()" class="btn btn-success">Start Voting</button>
                    </div>
                    <div class="form-group">
                        <button onclick="quickStartVoting()" class="btn btn-primary">Quick Start (1 hour)</button>
                        <small style="color: #666; display: block; margin-top: 5px;">Quickly start a 1-hour voting session</small>
                    </div>
                </div>

                <!-- End Voting -->
                <div class="card">
                    <h3>End Voting</h3>
                    <button onclick="endVoting()" class="btn btn-danger">End Voting</button>
                </div>

                <!-- Authorize Viewer -->
                <div class="card">
                    <h3>Authorize Viewer</h3>
                    <div class="form-group">
                        <input type="text" id="viewerAddress" placeholder="Viewer address (0x...)">
                        <button onclick="authorizeViewer()" class="btn btn-success">Authorize</button>
                    </div>
                    <div class="form-group">
                        <button onclick="authorizeSelf()" class="btn btn-primary">Authorize Myself to View Results</button>
                        <small style="color: #666; display: block; margin-top: 5px;">Quickly authorize current account to view voting results</small>
                    </div>
                </div>
            </div>

            <!-- Voter Functions -->
            <div class="section" id="voterSection" style="display: none;">
                <h2>üó≥Ô∏è Voter Functions</h2>
                
                <!-- Vote Options -->
                <div class="card">
                    <h3>Cast Your Vote</h3>
                    <div id="voteOptions" class="option-list">
                        <p>Loading vote options...</p>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="section" id="resultsSection" style="display: none;">
                <h2>üìä Voting Results</h2>
                
                <div class="card">
                    <button onclick="getVoteResults()" class="btn btn-primary">View Results</button>
                    <div id="voteResults" class="result-list">
                        <p>Click the button above to view voting results</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="section">
            <h3>üìù Activity Log</h3>
            <div class="card">
                <div id="logContainer" class="log-container">
                    <p>Logs will appear here...</p>
                </div>
                <button onclick="clearLogs()" class="btn btn-secondary" style="margin-top: 10px;">Clear Logs</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer" class="message-container"></div>

    <!-- App Script -->
    <script src="app.js"></script>
    <script>
        // Initialize app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitApp);
        } else {
            safeInitApp();
        }
    </script>
</body>
</html> 